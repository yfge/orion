# 微信公众号消息发送集成设计（初稿）

## 背景与目标
- Orion 需要支持微信生态内的服务号/订阅号通知，满足业务侧「事件触达」「模板消息」等场景。
- 核心目标：保证消息可靠投递、可观测、可追踪，遵循现有通知生命周期（pending/sending/success/failed/...）。
- 期望复用既有通道抽象（发送器接口、任务调度、状态机），在领域层新增最小必要扩展。

## 场景与成功判定
- **事务模板消息**：业务事件触发，根据模板 ID 和数据项渲染后发送到指定用户 OpenID；成功以微信返回 `msgid` 且网关状态为 `success` 为准。
- **客服消息补发**：失败或人工干预后，通过客服接口再次推送；要求记录补发动作并限制发送窗口（48 小时）。
- **回执与状态同步**：支持接收微信服务器回调，记录送达/失败原因并触发重试/告警。

## 依赖与输入
- 微信公众平台服务号，开通模板消息或客服消息权限。
- 关键凭证：`AppID`、`AppSecret`、模板 ID 列表、消息示例、服务器回调 Token。
- 预估 QPS/配额：微信单应用默认限流，需在速率限制策略中体现（例如 10 qps，日发送配额与模板消息限制）。

## 集成范围
- **消息类型**：首期支持模板消息（`/cgi-bin/message/template/send`）与客服消息（`/cgi-bin/message/custom/send`）。
- **接入能力**：
  - 调用微信 API 获取并缓存 Access Token。
  - 渲染模板数据字段，支持跳转 URL/小程序路径。
  - 处理微信公众号回调（明文模式起步，后续扩展 AES）。
- **数据记录**：存储发送请求、微信返回 `msgid`、错误码、回调事件。
- **非目标**：暂不支持群发、订阅通知（一次性订阅接口）、素材管理。

## 架构与职责划分
- **核心层（Domain/Services）**：
  - 新增微信公众号渠道实体，定义模板参数、跳转信息等结构体。
  - 扩展网关服务路由表，识别 `channel=wechat_official_account`。
  - 统一重试与状态流转逻辑，区分可重试错误（系统繁忙、超时）与不可重试错误（参数错误、用户拒收）。
- **外部适配层（Adapters）**：
  - 提供 `OAuthTokenProvider` 用于 Access Token 缓存与刷新（Redis/DB/内存策略待定）。
  - 调用微信模板/客服消息 API，封装请求签名、错误码解析、限流处理。
  - 暴露 webhook 处理器验证 `signature|timestamp|nonce` 并解析消息体。
- **配置/基础设施**：
  - 新增渠道配置项（AppID、AppSecret、token 缓存 TTL、API 域名）。
  - 支撑组件：HTTP 客户端（httpx session）、异步任务队列（现有 `backend/tasks/`）。
  - 运行时依赖：Prometheus 指标、结构化日志、告警规则。

## 风险与假设
- Access Token 每次刷新有效期约 2 小时，需要全局共享缓存；假设将使用 Redis（后备：数据库表）。
- 模板字段需预先注册且大小写敏感；需要在请求校验阶段捕获缺失字段。
- 回调接口需要公网可达；本地开发使用隧道或模拟器。
- 需评估微信错误码稳定性，设计映射表并保持可更新。

## 成功交付前的里程碑
1. 设计文档冻结（本文件），确认功能范围与依赖。
2. 完成凭证管理方案并更新运行手册。
3. 后端配置与领域模型到位，确保可编译通过。
4. 适配器、服务、API、回调、监控分阶段上线，配套测试完成。
5. 发布后完成首轮数据回顾并归档 agents_chat 日志。

## 开放问题
- Access Token 缓存介质最终选型？（Redis vs. DB vs. 内存）
- 是否需要同时支持订阅号（限制模板消息能力）？
- 回调推送采用明文还是加密模式作为默认？
- 运营是否需要后台配置管理界面（模板 ID、跳转链接等）？

此文档作为后续实现迭代的规范参考，后续如有范围变更需先更新本文件再调整实现。
