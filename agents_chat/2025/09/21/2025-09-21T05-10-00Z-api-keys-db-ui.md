---
id: 2025-09-21T05-10-00Z-api-keys-db-ui
date: 2025-09-21T05:10:00Z
participants: [human, orion-assistant]
models: [gpt-4o]
tags: [backend, frontend, auth, api-keys]
related_paths:
  - backend/app/db/models.py
  - backend/alembic/versions/0002_add_api_keys.py
  - backend/app/repository/api_keys.py
  - backend/app/schemas/api_keys.py
  - backend/app/api/v1/api_keys.py
  - backend/app/api/v1/router.py
  - backend/app/deps/api_key.py
  - frontend/app/api-keys/page.tsx
  - frontend/lib/api.ts
summary: "Add DB-backed API Keys (create/list/delete, hashed) and frontend management page; hook Notify auth to DB"
---

User original prompt and requirements

- 加入 API key 管理页面，API key 要保存在数据库中。

Background and goals

- 现有 Notify 依赖环境变量 `ORION_PUBLIC_API_KEY`。为灵活管控与审计，需要将 API Keys 落库、可增删，并在权限校验时查询数据库。

Changes

- Model & Migration：新增 `api_keys` 表（`ApiKey`，包含 name、token_hash、prefix/suffix、status/is_deleted 等）；Alembic 迁移 `0002_add_api_keys.py`。
- Repository：`create_api_key()` 生成随机 token、存储 sha256，`list_api_keys()`、`soft_delete_by_bid()`、`exists_by_token()`。
- Schemas：创建/列表输出模型，创建接口返回明文 token（仅一次）。
- API：`/api/v1/api-keys` 支持创建、列表、删除。
- Auth：`require_api_key()` 若环境变量不匹配，则解析请求中的 Bearer/Basic/X-API-Key 获取明文 token，sha256 后到 DB 校验。
- Frontend：新增 `/api-keys` 页面（创建/展示/删除），调用新 API；`frontend/lib/api.ts` 增加 SDK。

Outcome and impact

- 管理员可在控制台生成/删除 API Key，调用方可使用 Bearer（推荐）或 Basic/X-API-Key；Notify 校验将优先匹配环境变量，其次落库 Keys。

Next steps (TODO)

- 增加禁用/启用切换；分页与搜索；操作审计；后续考虑“作用域/限额/统计”。
